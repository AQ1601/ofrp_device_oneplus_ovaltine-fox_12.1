name: ğŸ¦Š OrangeFox Recovery - æœˆåº¦è‡ªåŠ¨æ„å»º

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox
# And all Contributors in every repositories I used

on:
  schedule:
    # UTC 16:00 = åŒ—äº¬æ—¶é—´ æ¯æœˆ 1 æ—¥ 00:00
    - cron: '0 16 1 * *'
  workflow_dispatch:

jobs:
  build:
    name: ğŸ—ï¸ æ„å»º OrangeFox Recovery
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===== æ„å»ºå‚æ•° =====
      MANIFEST_BRANCH: 12.1
      DEVICE_TREE: https://github.com/AQ1601/ofrp_device_oneplus_ovaltine-fox_12.1
      DEVICE_TREE_BRANCH: fox_12.1
      DEVICE_PATH: device/oneplus/ovaltine
      DEVICE_NAME: ovaltine
      BUILD_TARGET: recovery
      USE_CCACHE: true
      OF_MAINTAINER: AviderMin

    steps:

      - name: ğŸ§¹ æ¸…ç†æ„å»ºç©ºé—´
        uses: rokibhasansagar/slimhub_actions@main

      - name: ğŸ§° å®‰è£…æ„å»ºä¾èµ–ç¯å¢ƒ
        run: |
          sudo apt install -y aria2 linux-modules-extra-$(uname -r) zram-tools
          git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
          cd scripts
          sudo bash setup/android_build_env.sh
          cd ..
          rm -rf scripts
          sudo apt autoclean || true
          sudo apt autoremove -qy || true
          sudo rm -rf /var/cache/apt/archives/* || true

      - name: ğŸ’¾ æœ€å¤§åŒ–ç£ç›˜å¯ç”¨ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: '3072'

      - name: ğŸ“¥ æ‹‰å–ä»“åº“å†…å®¹
        uses: actions/checkout@main

      - name: âš™ï¸ é…ç½® ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: "2G"
          create-symlink: true

      - name: âš¡ å¯ç”¨å¹¶é…ç½® ZRAM
        run: |
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      - name: ğŸ“œ åŒæ­¥ OrangeFox æºç æ¸…å•
        run: |
          mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
          cd ${GITHUB_WORKSPACE}/OrangeFox

          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

          git clone https://gitlab.com/OrangeFox/sync.git -b master
          cd sync
          ./orangefox_sync.sh \
            --branch ${MANIFEST_BRANCH} \
            --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${MANIFEST_BRANCH}

      - name: ğŸ“¥ å…‹éš†è®¾å¤‡æ ‘æºç 
        run: |
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${MANIFEST_BRANCH}
          git clone ${DEVICE_TREE} -b ${DEVICE_TREE_BRANCH} ${DEVICE_PATH}
          cd ${DEVICE_PATH}
          echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: ğŸ§© æ³¨å…¥ OrangeFox Addons
        run: |
          git clone https://github.com/AviderMin/OrangeFox_Addons.git ${GITHUB_WORKSPACE}/addons
          cp ${GITHUB_WORKSPACE}/addons/* \
             ${GITHUB_WORKSPACE}/OrangeFox/fox_${MANIFEST_BRANCH}/vendor/recovery/Files/ || true

      - name: ğŸ”¨ ç¼–è¯‘ OrangeFox Recovery
        run: |
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${MANIFEST_BRANCH}
          set +e
          export FOX_BUILD_DEVICE=${DEVICE_NAME}
          export ALLOW_MISSING_DEPENDENCIES=true
          if [[ "${USE_CCACHE}" == "true" ]]; then
            export USE_CCACHE=1
            export CCACHE_EXEC=/usr/bin/ccache
            sed -i 's/return sandboxConfig\.working/return false/g' build/soong/ui/build/sandbox_linux.go
          fi
          source build/envsetup.sh
          set -e

          if [[ "${MANIFEST_BRANCH}" == "14.1" ]]; then
            lunch twrp_${DEVICE_NAME}-ap2a-eng
          else
            lunch twrp_${DEVICE_NAME}-eng
          fi

          make clean
          mka adbd ${BUILD_TARGET}image

      - name: ğŸ“Š æŸ¥çœ‹ ccache å‘½ä¸­ç»Ÿè®¡
        run: |
          ccache -sv

      - name: ğŸ·ï¸ ç”Ÿæˆå‘å¸ƒå…ƒä¿¡æ¯
        run: |
          echo "BUILD_DATE=$(TZ=Asia/Shanghai date +%Y%m%d)" >> $GITHUB_ENV

      - name: ğŸ“¦ è§„èŒƒåŒ–è¾“å‡ºæ–‡ä»¶å
        run: |
          echo "Searching OrangeFox artifacts..."

          mapfile -t FILES < <(
            find "${GITHUB_WORKSPACE}/OrangeFox" \
              -type f \( -name 'OrangeFox*.img' -o -name 'OrangeFox*.zip' \)
          )

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "ERROR: No OrangeFox artifacts found"
            exit 1
          fi

          for f in "${FILES[@]}"; do
            dir=$(dirname "$f")
            base=$(basename "$f")
            ext="${base##*.}"
            name="${base%.*}"
            mv "$f" "$dir/${name}-${BUILD_DATE}.${ext}"
          done

      - name: ğŸš€ å‘å¸ƒè‡³ GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: monthly-${{ env.BUILD_DATE }}
          name: OrangeFox Recovery for ${{ env.DEVICE_NAME }} // ${{ env.BUILD_DATE }}
          files: |
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/**/OrangeFox*.img
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/**/OrangeFox*.zip
          body: |
            ## OrangeFox Recovery Build (Automated)

            - Branch: fox_${{ env.MANIFEST_BRANCH }}
            - Device: ${{ env.DEVICE_NAME }}
            - Target: ${{ env.BUILD_TARGET }}
            - Device Tree: ${{ env.DEVICE_TREE }}
            - Commit: ${{ env.COMMIT_ID }}
            - Maintainer: ${{ env.OF_MAINTAINER }}
            - Build Date: ${{ env.BUILD_DATE }}
