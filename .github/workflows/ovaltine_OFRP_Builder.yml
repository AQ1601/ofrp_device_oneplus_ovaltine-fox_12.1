name: ü¶ä OrangeFox for ovaltine - ÊûÑÂª∫

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Ê∏ÖÂçïÂàÜÊîØ'
        required: true
        default: '12.1'
        type: choice
        options:
          - 14.1
          - 12.1
      DEVICE_TREE:
        description: 'OrangeFox ËÆæÂ§áÊ†ë'
        required: true
        default: 'https://github.com/AQ1601/ofrp_device_oneplus_ovaltine-fox_12.1'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox ËÆæÂ§áÊ†ëÂàÜÊîØ'
        required: true
        default: 'fox_12.1'
      DEVICE_PATH:
        description: 'ËæìÂÖ•‰Ω†ÁöÑËÆæÂ§áË∑ØÂæÑ'
        required: true
        default: 'device/oneplus/ovaltine'
      DEVICE_NAME:
        description: 'ËæìÂÖ•‰Ω†ÁöÑËÆæÂ§á‰ª£Âè∑'
        required: true
        default: 'ovaltine'
      BUILD_TARGET:
        description: 'ÈÄâÊã©‰Ω†ÁöÑÊûÑÂª∫ÁõÆÊ†á'
        required: true
        default: 'recovery'
        type: choice
        options:
          - boot
          - recovery
          - vendorboot
      USE_CCACHE:
        description: 'ÊòØÂê¶‰ΩøÁî® ccache ÁºñËØë'
        type: boolean
        required: true
        default: true
      OF_MAINTAINER:
        description: 'ËæìÂÖ•Áª¥Êä§ËÄÖÂêçÁß∞'
        required: true
        default: 'AviderMin'

jobs:
  build:
    name: üèóÔ∏è ÊûÑÂª∫ OrangeFox by ${{ github.actor }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:

      - name: üßπ Ê∏ÖÁêÜÊûÑÂª∫Á©∫Èó¥
        uses: rokibhasansagar/slimhub_actions@main

      - name: üß∞ ÂÆâË£ÖÊûÑÂª∫‰æùËµñÁéØÂ¢É
        run: |
          sudo apt install aria2 linux-modules-extra-$(uname -r) zram-tools -y
          git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
          cd scripts
          sudo bash setup/android_build_env.sh
          cd .. && rm -rf scripts

          sudo apt autoclean >/dev/null || true
          sudo apt autoremove -qy 2>/dev/null || true
          sudo rm -rf /var/cache/apt/archives/ 2>/dev/null || true
        
      - name: üíæ ÊúÄÂ§ßÂåñÁ£ÅÁõòÂèØÁî®Á©∫Èó¥
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: '3072'

      - name: üîç ÊãâÂèñ‰ªìÂ∫ìÂÜÖÂÆπ
        uses: actions/checkout@main

      - name: ‚öôÔ∏è ÈÖçÁΩÆ ccache ÁºñËØëÁºìÂ≠ò
        uses: hendrikmuhs/ccache-action@v1.2
        if: inputs.USE_CCACHE
        with:
          max-size: "2G"
          create-symlink: true

      - name: ‚ö° ÂêØÁî®Âπ∂ÈÖçÁΩÆ ZRAM
        run: |
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      - name: üìú ÂêåÊ≠• OrangeFox Ê∫êÁ†ÅÊ∏ÖÂçï
        if: inputs.MANIFEST_BRANCH == '12.1' || inputs.MANIFEST_BRANCH == '14.1'
        run: |
          mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
          cd ${GITHUB_WORKSPACE}/OrangeFox
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git clone https://gitlab.com/OrangeFox/sync.git -b master
          cd sync
          ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

      - name: üì° ‰øÆÂ§ç fox_14.1 WLAN ÊîØÊåÅ
        if: inputs.MANIFEST_BRANCH == '14.1'
        run: |
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
          git clone https://github.com/adontoo/android_external_libmicrohttpd -b ofox-14.1 external/libmicrohttpd
          rm -rf bionic
          git clone https://github.com/adontoo/OrangeFox-android_platform_bionic bionic
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/bootable/recovery
          git fetch https://github.com/ymdzq/OrangeFox_Recovery fox_14.1 && git cherry-pick 4aaf601 99e35fe 1ccd5e3

      - name: üì• ÂÖãÈöÜËÆæÂ§áÊ†ëÊ∫êÁ†Å
        run: |
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
          git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
          cd ${{ inputs.DEVICE_PATH }}
          echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: üß© Ê≥®ÂÖ• OrangeFox Addons
        run: |
          git clone https://github.com/AviderMin/OrangeFox_Addons.git ${GITHUB_WORKSPACE}/addons
          cp ${GITHUB_WORKSPACE}/addons/* \
             ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/vendor/recovery/Files/ || true

      - name: üî® ÁºñËØë OrangeFox Recovery
        run: |
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
          set +e
          export FOX_BUILD_DEVICE=${{ inputs.DEVICE_NAME }}
          if [[ ${{ inputs.USE_CCACHE }} == true ]]; then
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          sed -i 's/return sandboxConfig\.working/return false/g' build/soong/ui/build/sandbox_linux.go
          fi
          export ALLOW_MISSING_DEPENDENCIES=true
          source build/envsetup.sh
          set -e
          if [[ ${{ inputs.MANIFEST_BRANCH }} == '14.1' ]]; then
          lunch twrp_${{ inputs.DEVICE_NAME }}-ap2a-eng && make clean && mka adbd ${{ inputs.BUILD_TARGET }}image
          else
          lunch twrp_${{ inputs.DEVICE_NAME }}-eng && make clean && mka adbd ${{ inputs.BUILD_TARGET }}image
          fi

      - name: üìä Êü•Áúã ccache ÂëΩ‰∏≠ÁªüËÆ°
        run: |
          ccache -sv

      - name: üè∑Ô∏è ÁîüÊàêÂèëÂ∏ÉÂÖÉ‰ø°ÊÅØ
        run: |
          echo "BUILD_DATE=$(TZ=Asia/Shanghai date +%Y%m%d)" >> $GITHUB_ENV
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

          DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
          if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
            DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
          fi
          echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

      - name: üì¶ ËßÑËåÉÂåñËæìÂá∫Êñá‰ª∂Âêç
        run: |
          OUT_DIR=${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}

          for f in "$OUT_DIR"/OrangeFox*.img "$OUT_DIR"/OrangeFox*.zip; do
            [ -e "$f" ] || continue
            base=$(basename "$f")
            ext="${base##*.}"
            name="${base%.*}"
            mv "$f" "$OUT_DIR/${name}-${BUILD_DATE}.${ext}"
          done

      - name: üöÄ ÂèëÂ∏ÉËá≥ GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.run_id }}
          name: OrangeFox Recovery for ${{ inputs.DEVICE_NAME }} // ${{ env.BUILD_DATE }}
          files: |
            OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
            OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
          body: |
            ## OrangeFox Recovery Build - Unofficial

            Build Branch: fox_${{ inputs.MANIFEST_BRANCH }}
            Build Target: ${{ inputs.BUILD_TARGET }}
            Device Tree: ${{ inputs.DEVICE_TREE }}
            Device Tree Branch: ${{ inputs.DEVICE_TREE_BRANCH }}
            Commit: ${{ env.COMMIT_ID }}
            Maintainer: ${{ inputs.OF_MAINTAINER }}
            Build Date: ${{ env.BUILD_DATE }}
